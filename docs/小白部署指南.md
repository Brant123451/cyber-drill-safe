# 小白部署指南（从零开始）

> 本指南假设你没有任何服务器和编程经验。每一步都告诉你：做什么、点哪里、这一步是干什么的。

## 整体原理（先看懂再动手）

```
你买了 Windsurf Pro 套餐（每月 $15）
    │
    │  Windsurf 客户端发请求给 api.codeium.com
    │
    ▼
你电脑上的代理（mitmproxy）拦截这个请求
    │
    │  转发到你的服务器
    │
    ▼
你的服务器（网关）
    │
    │  从号池里选一个 Windsurf Pro 账号的登录态
    │  用这个登录态去请求 Codeium 官方服务器
    │
    ▼
Codeium 官方服务器返回 AI 回答
    │
    │  原路返回
    │
    ▼
Windsurf 客户端正常显示结果（它不知道中间发生了什么）
```

**简单说**：你买 1 个 Windsurf Pro 账号，通过这套系统可以让多台电脑共用。买多个账号可以并发更多人。

---

## 第一阶段：买 Windsurf Pro + 云服务器

### Step 1：买 Windsurf Pro 套餐

**做什么**：注册并购买 Windsurf Pro 订阅。

**点哪里**：
1. 打开浏览器 → 地址栏输入 `windsurf.com` → 回车
2. 点击「Sign Up」注册账号（用邮箱注册）
3. 登录后，点击「Pricing」或「Upgrade」
4. 选择「Pro」套餐（~$15/月）→ 付款
5. 记住你的 **邮箱** 和 **密码**，后面要用

如果要多人同时用，买多个账号（每个 $15/月）。

**这一步是干什么的**：
> Windsurf Pro 是一个 AI 编程助手的付费套餐，每月 $15 可以用 GPT-4o、Claude 等顶级 AI 模型。你买的这个账号就是“号源”，网关会用它的登录态去请求 AI。

---

### Step 2：注册阿里云账号

**做什么**：打开浏览器，访问 https://www.aliyun.com ，点右上角「免费注册」。

**点哪里**：
1. 打开浏览器 → 地址栏输入 `aliyun.com` → 回车
2. 右上角 → 「免费注册」
3. 用手机号注册 → 设置密码 → 完成实名认证（需要身份证）

**这一步是干什么的**：
> 你需要一台 24 小时在线的电脑（服务器）来运行网关程序。阿里云就是卖这种在线电脑的。先注册一个账号才能买。腾讯云（cloud.tencent.com）也可以，流程类似。

---

### Step 3：买一台 ECS 服务器

**做什么**：在阿里云控制台购买一台最便宜的云服务器。

**点哪里**：
1. 登录阿里云 → 顶部搜索栏输入「ECS」→ 点击「云服务器 ECS」
2. 点击「立即购买」
3. 选择以下配置：

| 配置项 | 选什么 | 为什么 |
|--------|--------|--------|
| 付费模式 | 按量付费（测试）或 包年包月（长期） | 按量付费随时可以关，包月更便宜 |
| 地域 | 随便选（建议选离你近的） | 离你近网速快 |
| 实例规格 | 2核4G（如 ecs.t6-c1m2.large） | 跑网关够用了 |
| 操作系统 | Ubuntu 22.04 LTS | 我们的脚本基于这个系统 |
| 系统盘 | 40G 就够 | 程序很小 |
| 公网带宽 | 按使用流量付费，勾选「分配公网IP」 | 你的电脑要能访问到它 |
| 登录凭证 | 自定义密码 | 记住这个密码！后面要用 |

4. 点击「确认订单」→「创建实例」
5. 等 1-2 分钟，服务器就创建好了

**这一步是干什么的**：
> 你买了一台 24 小时在线的 Linux 电脑。它有一个公网 IP 地址（类似 47.98.123.45），你的本地电脑通过这个 IP 访问它。这台电脑就是你的"中转服务器"。

---

### Step 4：记住你的服务器 IP 地址

**做什么**：在阿里云控制台找到你的服务器公网 IP。

**点哪里**：
1. 阿里云控制台 → 左侧菜单「云服务器 ECS」→「实例列表」
2. 找到你刚创建的实例
3. 在「公网 IP」列，你会看到一个类似 `47.98.123.45` 的地址
4. **把这个 IP 地址记下来**（复制到记事本）

**这一步是干什么的**：
> 这个 IP 就是你服务器的"门牌号"，后面所有操作都要用到它。

---

### Step 5：开放端口

**做什么**：让服务器的端口可以被外部访问。

**点哪里**：
1. 在实例列表页面，点击你的实例名称进入详情
2. 左侧菜单 →「安全组」→ 点击安全组 ID
3. 点击「手动添加」，添加以下规则：

| 方向 | 授权策略 | 端口范围 | 源 |
|------|----------|----------|-----|
| 入方向 | 允许 | 80/80 | 0.0.0.0/0 |
| 入方向 | 允许 | 443/443 | 0.0.0.0/0 |
| 入方向 | 允许 | 18790/18790 | 0.0.0.0/0 |

4. 点击「保存」

**这一步是干什么的**：
> 服务器默认把所有"门"都关着，不让外人进。你需要打开特定的"门"（端口），这样你的电脑才能连上去。18790 是网关程序用的端口，80/443 是网页用的标准端口。

---

## 第二阶段：连接服务器 + 部署网关

### Step 6：下载 SSH 工具

**做什么**：下载一个能连接到服务器的工具。

**点哪里**：
1. 浏览器访问 https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html
2. 下载「putty-64bit-xxx-installer.msi」（64位安装包）
3. 双击安装，一直点 Next → Install → Finish

**也可以用**：Windows 自带的 PowerShell（Win10/11 都有），打开方式：
- 按 Win 键 → 搜索「PowerShell」→ 点击打开

**这一步是干什么的**：
> SSH 工具就像一个"遥控器"，让你在自己的电脑上操作远程服务器。PuTTY 是最常用的免费 SSH 工具。

---

### Step 6：连接到服务器

**方式 A：用 PuTTY**：
1. 打开 PuTTY
2. 在 Host Name 框里输入你的服务器 IP（如 `47.98.123.45`）
3. Port 保持 22
4. 点击 Open
5. 弹出提示框点 Accept
6. 输入用户名：`root` → 回车
7. 输入密码（买服务器时设的那个，输入时看不到字符，正常的）→ 回车
8. 看到 `root@xxx:~#` 就表示连上了

**方式 B：用 PowerShell**：
1. 打开 PowerShell
2. 输入：`ssh root@47.98.123.45`（换成你的 IP）→ 回车
3. 第一次会问 yes/no → 输入 `yes` → 回车
4. 输入密码 → 回车

**这一步是干什么的**：
> 你现在已经"登录"到了远程服务器上。接下来你在这个窗口里输入的命令，都是在服务器上执行的。

---

### Step 8：上传项目文件到服务器

**做什么**：把 cyber-drill-safe-lab 文件夹上传到服务器。

**点哪里**（用 PowerShell 方式，在你自己电脑的 PowerShell 中执行）：

```powershell
# 在你电脑的 PowerShell 中执行（不是服务器的窗口！）
# 把 47.98.123.45 换成你的服务器 IP
scp -r D:\tests\cyber-drill-safe-lab root@47.98.123.45:/root/
```

输入服务器密码 → 等待上传完成。

**或者用 WinSCP**（图形界面，更简单）：
1. 下载 WinSCP：https://winscp.net/eng/download.php
2. 安装并打开
3. 主机名 = 你的服务器 IP，用户名 = root，密码 = 你的密码
4. 点击「登录」
5. 左边是你的电脑，右边是服务器
6. 左边找到 `D:\tests\cyber-drill-safe-lab` 文件夹
7. 把它拖到右边的 `/root/` 目录下

**这一步是干什么的**：
> 把你电脑上的网关程序复制到服务器上。就像把文件从 U 盘拷到另一台电脑。

---

### Step 9：一键部署

**做什么**：在服务器上执行一键部署脚本。

**点哪里**（在连接到服务器的 PuTTY 或 PowerShell 窗口中）：

```bash
cd /root/cyber-drill-safe-lab
bash scripts/cloud-deploy.sh
```

然后等待脚本自动运行，大约 3-5 分钟。你会看到很多输出，最后会显示类似：

```
[deploy] gateway is healthy!
[deploy] ======================================
[deploy]   Deployment Complete!
[deploy] ======================================
```

**这一步是干什么的**：
> 这个脚本自动完成所有服务器端配置：安装 Node.js 运行环境、启动网关程序、设置自动重启（万一崩了自动恢复）、配置 Nginx 反向代理、设置防火墙规则。你不需要懂这些，脚本全自动搞定。

---

### Step 10：验证服务器是否正常

**做什么**：确认网关已经在运行。

**点哪里**：
1. 打开你电脑的浏览器
2. 地址栏输入 `http://你的服务器IP:18790/health` → 回车
3. 如果显示 `{"ok":true,"service":"cyber-drill-safe-lab"}` → 成功！

**这一步是干什么的**：
> 网关有一个"体检"接口。你访问它，如果返回 ok:true 说明网关正在正常运行。

---

## 第三阶段：把 Windsurf 账号填入号池

### Step 11：拦截 Windsurf 的通信协议（抓包）

**做什么**：用 Wireshark / Chrome DevTools / mitmproxy 抓取 Windsurf 客户端与 Codeium 服务器之间的通信格式。

**点哪里**：
1. 在你电脑上打开 Windsurf，正常使用一次 AI 功能
2. 同时用 mitmproxy 拦截流量（后面 Step 14 会装）
3. 观察 Windsurf 发给 `api.codeium.com` 的请求格式：
   - 请求的 URL 路径是什么？
   - 请求头里有什么认证信息（Authorization / Cookie / Token）？
   - 请求 Body 是什么格式（JSON? protobuf?）？
   - 响应是什么格式？
4. 把观察到的内容记录下来

**这一步是干什么的**：
> Windsurf 客户端和 Codeium 服务器之间用的是它们自己的私有协议（不是标准的 OpenAI 格式）。你需要“破解”这个格式，网关才知道怎么把用户的请求转换成 Codeium 能懂的格式。
>
> ❗ **这是整个流程中最难的一步**，需要一定的技术能力或找懂技术的人帮你。抓到的协议格式需要填入 `src/protocol-adapter.js` 文件中标记 `[REVERSE-REQUIRED]` 的位置。

---

### Step 12：把 Windsurf 账号填入号池

**做什么**：把你的 Windsurf 账号信息写入配置文件，让网关知道用哪个账号。

**点哪里**（在连接到服务器的窗口中执行）：

```bash
# 编辑会话池配置
nano /root/cyber-drill-safe-lab/config/sessions.json
```

填入以下内容（多个账号就多加几个）：

```json
{
  "sessions": [
    {
      "id": "windsurf-账号1",
      "platform": "codeium",
      "email": "你的Windsurf邮箱",
      "sessionToken": "抓包拿到的session token",
      "dailyLimit": 100000,
      "enabled": true
    },
    {
      "id": "windsurf-账号2",
      "platform": "codeium",
      "email": "第二个账号邮箱",
      "sessionToken": "第二个账号的session token",
      "dailyLimit": 100000,
      "enabled": true
    }
  ]
}
```

保存：`Ctrl+X` → `Y` → 回车。

重新加载：

```bash
curl -X POST http://127.0.0.1:18790/admin/sessions/reload
```

看到 `"ok":true` 就行了。

**这一步是干什么的**：
> `sessionToken` 就是 Windsurf 账号的“登录态”。就像你登录微信后有一个登录状态，不用每次都重新输密码。网关拿着这个登录态去请求 Codeium 服务器，服务器以为是正常用户在用。
>
> 买了多个账号就多填几个，网关会自动轮流使用（用得最少的优先）。

---

### Step 12b（可选）：用脚本自动提取 session token

如果你不想手动抓包，可以试试自动登录脚本（但可能不稳定，因为平台可能更新登录页面）：

```bash
# 在服务器上安装 puppeteer
cd /root/cyber-drill-safe-lab
npm install puppeteer

# 自动登录并提取 session
node src/account-automation.js login \
  --platform codeium \
  --email "你的邮箱" \
  --password "你的密码"
```

成功后会自动写入 `config/sessions.json`。

**这一步是干什么的**：
> 脚本会打开一个隐藏的浏览器，自动在 Windsurf/Codeium 网站上登录你的账号，然后把登录后的 session token 拿出来存到配置文件里。就像有人帮你登录并记住密码。

---

## 第四阶段：配置客户端（你的 Windows 电脑）

### Step 13：安装 Node.js 和 Python

**做什么**：安装 Python（代理工具需要）和 Node.js（网关程序需要）。

**点哪里**：

**先装 Python：**
1. 浏览器访问 https://www.python.org/downloads/
2. 点击黄色大按钮「Download Python 3.x.x」
3. 双击下载的安装包
4. **勾选底部的「Add Python to PATH」** ← 这个很重要！
5. 点击「Install Now」
6. 等待安装完成 → Close

**再装 Node.js：**
1. 浏览器访问 https://nodejs.org/
2. 点击「LTS」版本的下载按钮
3. 双击安装，一路 Next → Install → Finish

**验证**：打开 PowerShell，分别输入 `python --version` 和 `node --version`，都看到版本号就行。

**这一步是干什么的**：
> Python 运行代理工具 mitmproxy，Node.js 运行网关程序。就像想用 Word 就得先装 Office。

---

### Step 14：一键配置客户端代理

**做什么**：运行脚本自动配置本地代理。

**点哪里**：
1. 以管理员身份打开 PowerShell：
   - 右键点击屏幕左下角 Windows 图标
   - 选择「Windows PowerShell（管理员）」或「终端（管理员）」
2. 执行以下命令（把 IP 换成你的服务器 IP）：

```powershell
cd D:\tests\cyber-drill-safe-lab

.\scripts\client-setup.ps1 `
  -GatewayUrl http://47.98.123.45:18790 `
  -GatewayToken sk-deploy-001 `
  -InterceptDomains "api.codeium.com,server.codeium.com,web-backend.codeium.com" `
  -ProxyPort 8080

# ❗ 把 47.98.123.45 换成你自己服务器的 IP！
```

3. 如果弹出安全提示，选择「是」或输入 `A` 全部允许
4. 脚本会自动：安装 mitmproxy → 生成证书 → 安装证书 → 生成启动脚本

**这一步是干什么的**：
> 这个脚本做了三件事：
> 1. **安装 mitmproxy**：一个能拦截 HTTPS 流量的代理工具
> 2. **安装证书**：让你的电脑信任代理的证书（否则浏览器会报不安全）
> 3. **生成启动脚本**：之后你只需要运行生成的脚本就能开启/关闭代理
>
> `InterceptDomains` 告诉代理“只拦截发往这些域名的请求”。这里填的是 Codeium/Windsurf 的服务器域名。你电脑上访问其他网站（百度、微信等）完全不受影响。

---

### Step 15：启动代理

**做什么**：启动本地 HTTPS 拦截代理。

**点哪里**：

**终端 1**（启动代理进程）：
```powershell
powershell -File client\start-proxy.ps1
```
保持这个窗口开着，不要关闭。

**终端 2**（另开一个 PowerShell 窗口，开启系统代理）：
```powershell
powershell -File client\enable-proxy.ps1
```

现在代理已经在工作了！

**这一步是干什么的**：
> 启动后，你电脑上的 Windsurf 客户端发给 `api.codeium.com` 的请求会被代理拦截，转发到你的服务器网关。网关用号池里的 Windsurf Pro 账号登录态去请求 Codeium 官方服务器，拿到 AI 回答后原路返回。
>
> Windsurf 客户端以为自己在跟官方通信，完全感知不到中间有你的网关在转发。

---

### Step 16：停止代理

**做什么**：不用时关闭代理。

**点哪里**：
1. 在终端 1 按 `Ctrl+C` 停止代理进程
2. 在终端 2 执行：
```powershell
powershell -File client\disable-proxy.ps1
```

**这一步是干什么的**：
> 关闭代理后，你的网络恢复正常，所有流量直接发到原始目标。记得不用时关掉，否则拦截的域名可能访问不了。

---

## 日常使用

每次要用的时候，只需要重复 Step 15（启动代理）。
不用的时候执行 Step 16（停止代理）。
服务器那边不需要动，它 24 小时自动运行。

---

## 常见问题

### Q: 浏览器提示"不安全"怎么办？
证书没安装好。重新运行一次 Step 13 的脚本。

### Q: 代理启动后某些网站打不开？
检查 `InterceptDomains` 是否只写了你需要拦截的域名。不要写太多，只拦截目标平台的域名。

### Q: 服务器重启后网关还在吗？
在。部署脚本配置了 PM2 进程守护和开机自启，服务器重启后网关会自动恢复。

### Q: session token 过期了怎么办？
Windsurf 的 session token 一般 24 小时过期。你需要定期重新登录并更新 token。如果用了 Docker 容器模式，容器会自动保活。

### Q: 怎么看网关运行状态？
在你电脑的 PowerShell 中执行：
```powershell
cd D:\tests\cyber-drill-safe-lab
npm run sessions:status     # 查看 Windsurf 会话池
```

### Q: 怎么添加更多 Windsurf 账号？
编辑服务器上的 `config/sessions.json`，添加更多账号。然后执行：
```bash
curl -X POST http://127.0.0.1:18790/admin/sessions/reload
```

---

## 费用估算

| 项目 | 费用 | 说明 |
|------|------|------|
| Windsurf Pro 套餐 | ~$15/月/个账号 (约¥110) | 这是你的“号源” |
| 阿里云 2核4G 服务器 | ~70-150 元/月 | 包年更便宜 |
| 域名（可选） | ~10-50 元/年 | 如果想用域名而不是 IP |
| **总计（1个账号）** | **~¥180/月** | 1个账号可以多人轮流用 |
| **总计（5个账号）** | **~¥620/月** | 并发 5 人同时用 |

---

## 整体流程图

```
你只需要做这些：

1. 买 Windsurf Pro ─────── 5 分钟（只做一次）
2. 买服务器 ─────────── 5 分钟（只做一次）
3. 一键部署服务器 ───── 3 分钟（只做一次）
4. 抓包 + 填号池 ────── 30-60 分钟（需要技术基础，只做一次）
5. 客户端安装 ──────── 5 分钟（只做一次）
6. 每天启动/停止代理 ─ 10 秒（日常使用）

❗ Step 11（抓包协议）是整个流程中唯一需要技术能力的步骤。
其他步骤都是照着做就行。
```

---

## 替代方案：OpenClaw 直连模式（推荐新手）

> 如果你觉得上面的 MITM 代理太复杂，可以改用 OpenClaw 直连模式。
> **不需要装证书、不需要抓包、不需要管理员权限。**

### 原理

```
用户电脑上运行 OpenClaw（一个开源 AI 编程助手）
    │
    │  OpenClaw 发 LLM 请求到你的服务器
    │
    ▼
你的服务器（网关）
    │
    │  从号池选账号 → 转发到上游 LLM API
    │
    ▼
上游 LLM API 返回 AI 回答
```

### 管理员操作（在服务器上）

1. 部署网关（和上面一样：`npm run setup:ps` → `npm run deploy:ps`）
2. 在 `config/accounts.json` 里配置你的 LLM API Key（如 DeepSeek）
3. 为每个用户创建账号：

```powershell
# 在服务器上执行
npm run users:create
# 或用 API：
# curl -X POST http://127.0.0.1:18790/admin/users/create -H "Content-Type: application/json" -d "{\"name\": \"张三\"}"
# 返回的 token（sk-gw-xxx...）发给用户
```

### 用户操作（在自己电脑上）

1. 安装 Node.js（去 nodejs.org 下载安装）
2. 下载 OpenClaw 并编译（需要管理员帮忙提供）
3. 管理员在用户电脑上执行一键配置：

```powershell
.\scripts\openclaw-setup.ps1 -GatewayUrl http://服务器IP:18790 -ApiKey "sk-gw-管理员给你的key"
```

4. 启动：`node dist/entry.js gateway run --port 18789`
5. 浏览器打开 `http://localhost:18789` 即可使用

### 查询剩余积分

浏览器打开：`http://服务器IP:18790/v1/credits`（需要带 API Key）

或在 PowerShell 中：
```powershell
Invoke-RestMethod -Uri "http://服务器IP:18790/v1/credits" -Headers @{Authorization="Bearer sk-gw-你的key"}
```

### 对比

| | MITM 代理模式 | OpenClaw 直连模式 |
|---|---|---|
| 客户端 | Windsurf + mitmproxy | OpenClaw |
| 需要证书？ | 是 | 否 |
| 需要抓包？ | 是 | 否 |
| 技术门槛 | 高（Step 11 抓包） | 低（一键配置） |
| 适合场景 | 必须用 Windsurf 的团队 | 只需要 AI 编程的团队 |
